/**
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * 40-acts.js โ ะะฐะฑะพัะฐ ั ะปะธััะพะผ "ะะะะกะขะ ะะะขะะ"
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 * 
 * ะญัะพั ัะฐะนะป ะพัะฒะตัะฐะตั ะทะฐ ัะฐะฑะพัั ั ัะตะตัััะพะผ ะฐะบัะพะฒ ะฒัะฟะพะปะฝะตะฝะฝัั ัะฐะฑะพั.
 * 
 * ะงัะพ ัะฐะบะพะต ะฐะบั?
 * ะญัะพ ะดะพะบัะผะตะฝั, ะฟะพะดัะฒะตัะถะดะฐััะธะน ะฒัะฟะพะปะฝะตะฝะฝัะต ัะฐะฑะพัั. ะ ะฝัะผ ัะบะฐะทะฐะฝั:
 * - ะะดัะตั ะพะฑัะตะบัะฐ
 * - ะะพะผะตั ะฐะบัะฐ
 * - ะกัะผะผะฐ ะฒััััะบะธ
 * - ะะฐัะฟะปะฐัะฐ ะฟัะพัะฐะฑะฐ
 * - ะะตะฟะพะทะธั (ะทะฐะปะพะณ)
 * - ะคะปะฐะณะธ: ะพะฟะปะฐัะตะฝะพ, ะฒัะดะฐะฝะพ ะฟัะพัะฐะฑั, ะฒะพะทะฒัะฐััะฝ ะดะตะฟะพะทะธั
 * 
 * ะัะฝะพะฒะฝัะต ะทะฐะดะฐัะธ:
 * - ะัััััะน ะฟะพะธัะบ ะฐะบัะฐ ะฟะพ ะฐะดัะตัั ะธ ะฝะพะผะตัั
 * - ะัะพััะฐะฒะปะตะฝะธะต ะณะฐะปะพัะตะบ (ัะปะฐะณะพะฒ) ะฟัะธ ะฒัะฟะปะฐัะฐั
 * - ะะพะดัะฒะตัะบะฐ ะพะฟะปะฐัะตะฝะฝัั ะฐะบัะพะฒ ัะฒะตัะพะผ
 * โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 */

// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะะะะขะ ะะะะะะะ ะะะกะขะ "ะะะะกะขะ ะะะขะะ"
// โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
// ะะผะตััะพ ัะพะณะพ ััะพะฑั ะฟะธัะฐัั "ะบะพะปะพะฝะบะฐ 2" ะธะปะธ "B", ะธัะฟะพะปัะทัะตะผ ะฟะพะฝััะฝัะต ะธะผะตะฝะฐ
const ACTS_COL = {
  ADDR: 2,          // B โ ะะดัะตั ะพะฑัะตะบัะฐ (ะฝะฐะฟัะธะผะตั, "ัะป. ะะตะฝะธะฝะฐ, 15")
  ACTNO: 3,         // C โ ะะพะผะตั ะฐะบัะฐ (ะฝะฐะฟัะธะผะตั, "ะะะข-123/2025")
  REVENUE: 5,       // E โ ะกัะผะผะฐ ะฐะบัะฐ (ะฒััััะบะฐ)
  WAGE_BY_ACT: 9,   // I โ ะะฐัะฟะปะฐัะฐ ะฟะพ ะฐะบัั (ะดะปั ะฟัะพัะฐะฑะฐ)
  DEPOSIT: 10,      // J โ ะะตะฟะพะทะธั (ะทะฐะปะพะณ)
  HANDS: 11,        // K โ ะกัะผะผะฐ ะฝะฐ ััะบะธ ะฟัะพัะฐะฑั
  MASTER_FLAG: 16,  // P โ ะะฐะปะพัะบะฐ "ะะฐัะฟะปะฐัะฐ ะฒัะฟะปะฐัะตะฝะฐ"
  RET_FLAG: 17,     // Q โ ะะฐะปะพัะบะฐ "ะะตะฟะพะทะธั ะฒะพะทะฒัะฐััะฝ"
  PAID_FLAG: 18     // R โ ะะฐะปะพัะบะฐ "ะะบั ะพะฟะปะฐัะตะฝ"
};

/**
 * ะกััะพะธั ะธะฝะดะตะบั ะฐะบัะพะฒ ะดะปั ะฑััััะพะณะพ ะฟะพะธัะบะฐ
 * 
 * ะัะพะฑะปะตะผะฐ: ะตัะปะธ ะฐะบัะพะฒ ัะพัะฝะธ, ะธัะบะฐัั ะบะฐะถะดัะน ัะฐะท ะฟะตัะตะฑะพัะพะผ ะฒัะตั ัััะพะบ โ ะผะตะดะปะตะฝะฝะพ.
 * 
 * ะะตัะตะฝะธะต: ะพะดะธะฝ ัะฐะท ะฟัะพัะธัะฐัั ะฒัะต ะฐะบัั ะธ ัะพะทะดะฐัั "ะบะฐััั":
 *   "ัะป.ะะตะฝะธะฝะฐ|ะะะข-123" โ ัััะพะบะฐ 15
 *   "ะฟั.ะะธัะฐ|ะะะข-456"  โ ัััะพะบะฐ 27
 * 
 * ะขะตะฟะตัั ะฟะพะธัะบ ะผะณะฝะพะฒะตะฝะฝัะน: ะฑะตััะผ ะบะปัั, ัะผะพััะธะผ ะฒ ะบะฐััั โ ะฟะพะปััะฐะตะผ ะฝะพะผะตั ัััะพะบะธ.
 * 
 * @param {Sheet} shActs - ะะธัั "ะะะะกะขะ ะะะขะะ"
 * @returns {Object} - ะะฑัะตะบั ั ะดะฒัะผั ะฟะพะปัะผะธ:
 *   - actsGrid: ะผะฐััะธะฒ ะฒัะตั ัััะพะบ ะฐะบัะพะฒ
 *   - keyToRow: ะบะฐััะฐ "ะฐะดัะตั|ะฐะบั" โ ะฝะพะผะตั ัััะพะบะธ
 */
function buildActsIndex_(shActs) {
  const res = { actsGrid: null, keyToRow: {} };
  
  // ะัะปะธ ะปะธัั ะฟัััะพะน ะธะปะธ ัะพะดะตัะถะธั ัะพะปัะบะพ ะทะฐะณะพะปะพะฒะพะบ โ ะฒะพะทะฒัะฐัะฐะตะผ ะฟัััะพะน ะธะฝะดะตะบั
  if (!shActs || shActs.getLastRow() <= 1) return res;

  const lastActsRow = shActs.getLastRow();
  
  // ะงะธัะฐะตะผ ะฒัะต ัััะพะบะธ ะฐะบัะพะฒ ะพะดะฝะธะผ ะทะฐะฟัะพัะพะผ (ะฑััััะตะต, ัะตะผ ะฟะพ ะพะดะฝะพะน)
  // ะกััะพะบะธ 2 ะธ ะฝะธะถะต (ะฟะตัะฒะฐั ัััะพะบะฐ โ ะทะฐะณะพะปะพะฒะพะบ)
  // ะะพะปะพะฝะบะธ A:R (18 ะบะพะปะพะฝะพะบ)
  const actsGrid = shActs.getRange(2, 1, lastActsRow - 1, 18).getValues();
  const keyToRow = {};

  // ะัะพัะพะดะธะผ ะฟะพ ะฒัะตะผ ัััะพะบะฐะผ ะธ ัััะพะธะผ ะบะฐััั
  for (let i = 0; i < actsGrid.length; i++) {
    const row = actsGrid[i];
    const addrCell = row[ACTS_COL.ADDR - 1];  // ะะตััะผ ะฐะดัะตั (ะบะพะปะพะฝะบะฐ B)
    const actCell  = row[ACTS_COL.ACTNO - 1]; // ะะตััะผ ะฝะพะผะตั ะฐะบัะฐ (ะบะพะปะพะฝะบะฐ C)
    
    // ะกะพะทะดะฐัะผ ัะฝะธะบะฐะปัะฝัะน ะบะปัั ะฒะธะดะฐ "ะฐะดัะตั|ะฐะบั"
    const key = makeActKey(addrCell, actCell);
    if (!key) continue; // ะัะพะฟััะบะฐะตะผ ะฟััััะต ัััะพะบะธ
    
    // ะะฐะฟะพะผะธะฝะฐะตะผ ะฝะพะผะตั ัััะพะบะธ (i+2, ะฟะพัะพะผั ััะพ ะฟะตัะฒะฐั ัััะพะบะฐ ะดะฐะฝะฝัั = ัััะพะบะฐ 2)
    if (!keyToRow[key]) {
      keyToRow[key] = 2 + i;
    }
  }

  res.actsGrid = actsGrid;
  res.keyToRow = keyToRow;
  return res;
}

/**
 * ะัะตั ะฐะบั ะฒ ะธะฝะดะตะบัะต ะฟะพ ะบะปััั ะฐะดัะตั|ะฐะบั
 * 
 * ะญัะฐ ััะฝะบัะธั ะฝะฐัะพะดะธั ัััะพะบั ะฐะบัะฐ ะธ ะฒะพะทะฒัะฐัะฐะตั:
 * - ะะพะผะตั ัััะพะบะธ ะฒ ัะฐะฑะปะธัะต
 * - ะะฝะดะตะบั ะฒ ะผะฐััะธะฒะต actsGrid
 * - ะคะปะฐะณะธ: ะพะฟะปะฐัะตะฝะพ ะปะธ, ะฒัะดะฐะฝะพ ะปะธ, ะฒะพะทะฒัะฐััะฝ ะปะธ ะดะตะฟะพะทะธั
 * 
 * @param {Array} actsGrid - ะะฐััะธะฒ ัััะพะบ ะฐะบัะพะฒ (ะธะท buildActsIndex_)
 * @param {Object} keyToRow - ะะฐััะฐ ะบะปััะตะน โ ัััะพะบ (ะธะท buildActsIndex_)
 * @param {string} key - ะะปัั ะฒะธะดะฐ "ะฐะดัะตั|ะฐะบั"
 * @returns {Object} - ะะฝัะพัะผะฐัะธั ะพะฑ ะฐะบัะต:
 *   - row: ะฝะพะผะตั ัััะพะบะธ ะฒ ัะฐะฑะปะธัะต (0 ะตัะปะธ ะฝะต ะฝะฐะนะดะตะฝ)
 *   - gridIndex: ะธะฝะดะตะบั ะฒ ะผะฐััะธะฒะต actsGrid (-1 ะตัะปะธ ะฝะต ะฝะฐะนะดะตะฝ)
 *   - paid: true ะตัะปะธ ะฐะบั ะพะฟะปะฐัะตะฝ
 *   - master: true ะตัะปะธ ะทะฐัะฟะปะฐัะฐ ะฒัะฟะปะฐัะตะฝะฐ
 *   - ret: true ะตัะปะธ ะดะตะฟะพะทะธั ะฒะพะทะฒัะฐััะฝ
 *   - error: ะบะพะด ะพัะธะฑะบะธ ('no_data', 'not_found') ะธะปะธ null
 */
function findActRowByKey_(actsGrid, keyToRow, key) {
  // ะัะปะธ ะธะฝะดะตะบั ะฝะต ะฟะพัััะพะตะฝ โ ะฒะพะทะฒัะฐัะฐะตะผ ะพัะธะฑะบั
  if (!actsGrid) {
    return { row: 0, gridIndex: -1, paid: false, master: false, ret: false, error: 'no_data' };
  }
  
  // ะัะปะธ ะบะปัั ะฟัััะพะน โ ะฐะบั ะฝะต ะผะพะถะตั ะฑััั ะฝะฐะนะดะตะฝ
  if (!key) {
    return { row: 0, gridIndex: -1, paid: false, master: false, ret: false, error: 'not_found' };
  }

  // ะัะตะผ ะฒ ะบะฐััะต
  const row = keyToRow[key];
  if (!row) {
    return { row: 0, gridIndex: -1, paid: false, master: false, ret: false, error: 'not_found' };
  }

  // ะะฐัะปะธ! ะะตััะผ ะดะฐะฝะฝัะต ะธะท ะผะฐััะธะฒะฐ
  const gridIndex = row - 2;      // ะัะตะพะฑัะฐะทัะตะผ ะฝะพะผะตั ัััะพะบะธ ะฒ ะธะฝะดะตะบั ะผะฐััะธะฒะฐ
  const gridRow   = actsGrid[gridIndex];

  // ะงะธัะฐะตะผ ัะปะฐะณะธ (ะณะฐะปะพัะบะธ)
  const paid   = !!gridRow[ACTS_COL.PAID_FLAG   - 1]; // ะะฟะปะฐัะตะฝะพ?
  const master = !!gridRow[ACTS_COL.MASTER_FLAG - 1]; // ะะฐัะฟะปะฐัะฐ ะฒัะฟะปะฐัะตะฝะฐ?
  const ret    = !!gridRow[ACTS_COL.RET_FLAG    - 1]; // ะะตะฟะพะทะธั ะฒะพะทะฒัะฐััะฝ?

  return { row, gridIndex, paid, master, ret, error: null };
}

/**
 * ะัะพััะฐะฒะปัะตั ะณะฐะปะพัะบะธ ะฒ ะบะพะปะพะฝะบะฐั P (ะทะฐัะฟะปะฐัะฐ) ะธ Q (ะดะตะฟะพะทะธั)
 * 
 * ะะพะณะดะฐ ะฟัะพะฒะพะดะธะผ ะฒัะฟะปะฐัั ะทะฐัะฟะปะฐัั ะธะปะธ ะฒะพะทะฒัะฐั ะดะตะฟะพะทะธัะฐ, ะฝัะถะฝะพ ะฟะพััะฐะฒะธัั
 * ะณะฐะปะพัะบั ะฒ ัะพะพัะฒะตัััะฒัััะตะน ะบะพะปะพะฝะบะต ะะะะกะขะ ะะะขะะ.
 * 
 * ะญัะฐ ััะฝะบัะธั ะดะตะปะฐะตั ััะพ ะฑะฐััะตะผ (ััะฐะทั ะดะปั ะฒัะตั ัััะพะบ), ััะพะฑั ะฝะต ะดััะณะฐัั
 * API Google Sheets ะผะฝะพะณะพ ัะฐะท.
 * 
 * @param {Sheet} shActs - ะะธัั "ะะะะกะขะ ะะะขะะ"
 * @param {Set<number>} masterFlagRows - ะะพะผะตัะฐ ัััะพะบ, ะณะดะต ะฝัะถะฝะพ ะฟะพััะฐะฒะธัั ะณะฐะปะพัะบั "ะะฐัะฟะปะฐัะฐ"
 * @param {Set<number>} depFlagRows - ะะพะผะตัะฐ ัััะพะบ, ะณะดะต ะฝัะถะฝะพ ะฟะพััะฐะฒะธัั ะณะฐะปะพัะบั "ะะตะฟะพะทะธั"
 */
function applyActsFlags_(shActs, masterFlagRows, depFlagRows) {
  if (!shActs) return;
  
  const lastActsRow = shActs.getLastRow();
  if (lastActsRow <= 1) return; // ะะตั ะดะฐะฝะฝัั

  /**
   * ะัะฟะพะผะพะณะฐัะตะปัะฝะฐั ััะฝะบัะธั: ะฟัะพััะฐะฒะปัะตั ะณะฐะปะพัะบะธ ะฒ ะพะดะฝะพะน ะบะพะปะพะฝะบะต
   * 
   * @param {number} colIndex - ะะพะผะตั ะบะพะปะพะฝะบะธ (P=16 ะธะปะธ Q=17)
   * @param {Set<number>} rowsSet - ะะฝะพะถะตััะฒะพ ะฝะพะผะตัะพะฒ ัััะพะบ ะดะปั ะฟัะพััะฐะฒะปะตะฝะธั ะณะฐะปะพัะตะบ
   */
  function setFlagColumn(colIndex, rowsSet) {
    if (!rowsSet || rowsSet.size === 0) return; // ะะตัะตะณะพ ะฟัะพััะฐะฒะปััั
    
    // ๐ ะะะขะะะะะะฆะะฏ: ะดะปั ะผะฐะปัั ะธะทะผะตะฝะตะฝะธะน (<5 ัััะพะบ) โ ัะพัะตัะฝัะต ะพะฟะตัะฐัะธะธ
    if (rowsSet.size < 5) {
      rowsSet.forEach(r => {
        shActs.getRange(r, colIndex).setValue(true);
      });
      return;
    }
    
    // ะะปั ะฑะพะปััะธั ะธะทะผะตะฝะตะฝะธะน โ ะฑะฐััะตะฒะฐั ะพะฟะตัะฐัะธั
    const height = Math.max(1, lastActsRow - 1);
    const colRange = shActs.getRange(2, colIndex, height, 1);
    const colVals = colRange.getValues();
    
    rowsSet.forEach(r => {
      const idx = r - 2;
      if (idx >= 0 && idx < colVals.length) {
        colVals[idx][0] = true;
      }
    });
    
    colRange.setValues(colVals);
  }

  setFlagColumn(ACTS_COL.MASTER_FLAG, masterFlagRows);
  setFlagColumn(ACTS_COL.RET_FLAG,    depFlagRows);
}

/** ะะพะดัะฒะตัะบะฐ ะฒััััะบะธ ะฟะพ ะฐะบัั (E) โ ะฑะฐััะตะผ */
function applyRevenueColors_(shActs, revenueColorsByRow) {
  if (!shActs) return;
  const keys = Object.keys(revenueColorsByRow || {}).map(k => Number(k)).filter(n => Number.isFinite(n));
  if (!keys.length) return;
  const minRow = Math.min(...keys);
  const maxRow = Math.max(...keys);
  const height = maxRow - minRow + 1;
  const bg = Array.from({length: height}, () => [null]);
  keys.forEach(r => {
    const color = revenueColorsByRow[String(r)];
    if (color) bg[r - minRow][0] = color;
  });
  shActs.getRange(minRow, 5, height, 1).setBackgrounds(bg);
}

/**
 * ะะฐัััะบะธะฒะฐะฝะธะต + ะทะตะปัะฝัะน ัะพะฝ ะดะปั ะฒัะฟะปะฐั ะะ/ะดะตะฟะพะทะธัะฐ
 * ๐ ะะะขะะะะะะะะะะะ: ะฑะฐััะตะฒะฐั ะพะฑัะฐะฑะพัะบะฐ ะดะปั >5 ัััะพะบ, ัะพัะตัะฝะฐั ะดะปั โค5
 * 
 * @param {Sheet} shActs - ะะธัั "ะะะะกะขะ ะะะขะะ"
 * @param {number} colIndex - ะะพะผะตั ะบะพะปะพะฝะบะธ (ACTS_COL.HANDS ะธะปะธ ACTS_COL.DEPOSIT)
 * @param {Set<number>} rowsSet - ะะฝะพะถะตััะฒะพ ะฝะพะผะตัะพะฒ ัััะพะบ ะดะปั ััะธะปะธะทะฐัะธะธ
 */
function applyStyleBlocks_(shActs, colIndex, rowsSet) {
  if (!shActs || !rowsSet || rowsSet.size === 0) return;
  
  const rows = Array.from(rowsSet).sort((a,b)=>a-b);
  
  // ๐ ะะะขะะะะะะฆะะฏ: ะดะปั ะผะฐะปัั ะธะทะผะตะฝะตะฝะธะน (<5 ัััะพะบ) โ ัะพัะตัะฝัะต ะพะฟะตัะฐัะธะธ
  if (rows.length < 5) {
    rows.forEach(r => {
      const cell = shActs.getRange(r, colIndex);
      cell.setBackground(COLOR_BG_FULL_GREEN);
      cell.setFontColor(COLOR_FONT_DARKGREEN);
      cell.setNote('');
      cell.setFontLine('line-through');
    });
    return;
  }
  
  // ะะปั ะฑะพะปััะธั ะธะทะผะตะฝะตะฝะธะน โ ะฑะฐััะตะฒะฐั ะพะฟะตัะฐัะธั
  const minRow = rows[0];
  const maxRow = rows[rows.length - 1];
  const height = maxRow - minRow + 1;

  const rng = shActs.getRange(minRow, colIndex, height, 1);
  
  const existingBG = rng.getBackgrounds();
  const existingFontColors = rng.getFontColors();
  const existingNotes = rng.getNotes();
  const existingFontLines = rng.getFontLines();

  rows.forEach(r => {
    const idx = r - minRow;
    existingBG[idx][0] = COLOR_BG_FULL_GREEN;
    existingFontColors[idx][0] = COLOR_FONT_DARKGREEN;
    existingNotes[idx][0] = '';
    existingFontLines[idx][0] = 'line-through';
  });

  rng.setBackgrounds(existingBG);
  rng.setFontColors(existingFontColors);
  rng.setNotes(existingNotes);
  rng.setFontLines(existingFontLines);
}
